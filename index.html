<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تحويل النص إلى فيديو MP4 مع صوت عربي</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
<style>
body { font-family:'Inter',sans-serif; direction:rtl; }
.video-container { width:100%;height:300px;background:#000;position:relative;border-radius:1rem;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.video-image { width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 0.8s ease-in-out;position:absolute;top:0;left:0;}
.text-overlay { position:absolute;bottom:2rem;background:rgba(0,0,0,0.6);color:white;padding:0.5rem 1rem;border-radius:0.5rem;max-width:90%;text-align:center;font-size:1.5rem;font-weight:bold;opacity:0;transition:opacity 0.5s;}
.loading-spinner { border:4px solid rgba(255,255,255,0.3); border-radius:50%; border-top:4px solid #fff; width:40px;height:40px; animation:spin 1s linear infinite;}
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-2xl text-right">
<h1 class="text-3xl font-bold mb-6 text-center">تحويل النص إلى فيديو MP4 مع صوت عربي</h1>

<textarea id="text-input" class="w-full h-40 p-4 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="اكتب نصك هنا..."></textarea>

<div class="video-container mt-6">
  <img id="video-image" class="video-image" src="" alt="صورة المشهد">
  <p id="message-box" class="text-white text-center text-lg p-4 hidden">جاري التحويل...</p>
</div>

<a id="download-link" class="mt-4 block bg-green-600 text-white px-4 py-2 rounded-xl text-center hidden" download="video.mp4">تحميل الفيديو</a>

<button id="convert-btn" class="mt-4 block bg-blue-600 text-white px-4 py-2 rounded-xl text-center">تحويل النص إلى فيديو</button>
</div>

<script type="module">
import { createFFmpeg, fetchFile } from "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js";

const ffmpeg = createFFmpeg({ log: true });
const textInput = document.getElementById('text-input');
const videoImage = document.getElementById('video-image');
const messageBox = document.getElementById('message-box');
const downloadLink = document.getElementById('download-link');
const convertBtn = document.getElementById('convert-btn');

const PEXELS_API_KEY = "ضع مفتاح Pexels هنا";

async function fetchRandomImage() {
  const resp = await fetch("https://api.pexels.com/v1/search?query=nature&per_page=1", {
    headers:{Authorization:PEXELS_API_KEY}
  });
  const data = await resp.json();
  if(data.photos && data.photos.length>0) return data.photos[0].src.medium;
  throw new Error("لم يتم العثور على صورة");
}

async function textToSpeech(text) {
  // توليد الصوت بصيغة WAV
  return new Promise((resolve, reject) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "ar-SA";
    const chunks = [];
    const mediaStreamDestination = new MediaStreamAudioDestinationNode(new AudioContext());
    const mediaRecorder = new MediaRecorder(mediaStreamDestination.stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = () => resolve(new Blob(chunks, { type: 'audio/wav' }));
    const synth = window.speechSynthesis;
    synth.speak(utterance);
    utterance.onend = () => mediaRecorder.stop();
    mediaRecorder.start();
  });
}

convertBtn.addEventListener('click', async () => {
  const text = textInput.value.trim();
  if(!text) return alert("الرجاء إدخال النص أولاً.");
  messageBox.classList.remove('hidden');
  messageBox.innerText = "جاري إنشاء الفيديو...";
  downloadLink.classList.add('hidden');

  try {
    const imageUrl = await fetchRandomImage();
    videoImage.src = imageUrl;
    videoImage.style.opacity = 1;

    // --- توليد الصوت (ملف WAV مؤقت) ---
    const audioBlob = await textToSpeech(text);
    const audioData = await audioBlob.arrayBuffer();

    if(!ffmpeg.isLoaded()) await ffmpeg.load();
    const imgResp = await fetch(imageUrl);
    const imgData = await imgResp.arrayBuffer();
    ffmpeg.FS('writeFile','image.png',new Uint8Array(imgData));
    ffmpeg.FS('writeFile','audio.wav',new Uint8Array(audioData));

    // دمج الصورة مع الصوت في فيديو MP4 لمدة 5 ثوانٍ
    await ffmpeg.run('-loop','1','-i','image.png','-i','audio.wav','-c:v','libx264','-t','5','-pix_fmt','yuv420p','-c:a','aac','-shortest','output.mp4');

    const data = ffmpeg.FS('readFile','output.mp4');
    const videoBlob = new Blob([data.buffer], { type:'video/mp4' });
    downloadLink.href = URL.createObjectURL(videoBlob);
    downloadLink.classList.remove('hidden');
    messageBox.innerText = "تم إنشاء الفيديو!";

  } catch(err) {
    messageBox.innerText = "فشل إنشاء الفيديو: " + err.message;
    console.error(err);
  }
});
</script>

</body>
</html>
